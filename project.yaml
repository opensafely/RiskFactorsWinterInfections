version: '3.0'

expectations:

  population_size: 200000

actions:

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create_project_actions.R 
  ## Edit and run create_project_actions.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ## Generate study population - winter2019 

  generate_study_population-winter2019:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_winter2019
      --output-format csv.gz
    outputs:
      highly_sensitive:
        cohort: output/input_winter2019.csv.gz

  ## Describe - input_winter2019.csv.gz 

  describe-input_winter2019:
    run: stata-mp:latest analysis/describe.do input_winter2019 csv
    outputs:
      highly_sensitive:
        cohort: output/describe-input_winter2019.log

  ## Data cleaning - winter2019 

  data_cleaning-winter2019:
    run: stata-mp:latest analysis/data_cleaning.do winter2019 td(1dec2019) td(28feb2020)
    needs: generate_study_population_winter2019
    outputs:
      moderately_sensitive:
        consort: output/consort_winter2019.csv
        rounded_consort: output/rounded_consort_winter2019.csv
      highly_sensitive:
        cohort: output/clean_winter2019.dta.gz

  ## Describe - clean_winter2019.dta.gz 

  describe-input_winter2019:
    run: stata-mp:latest analysis/describe.do clean_winter2019 dta
    outputs:
      highly_sensitive:
        cohort: output/describe-clean_winter2019.log

  ## Table 1 - winter2019 

  table1-winter2019:
    run: stata-mp:latest analysis/table1.do winter2019
    needs: data_cleaning_winter2019
    outputs:
      moderately_sensitive:
        table1: output/table1_winter2019.csv
        rounded_table1: output/rounded_table1_winter2019.csv

  ## Table 2 - winter2019 

  table2-winter2019:
    run: stata-mp:latest analysis/table2.do winter2019
    needs: data_cleaning_winter2019
    outputs:
      moderately_sensitive:
        table1: output/table2_winter2019.csv
        rounded_table1: output/rounded_table2_winter2019.csv

  ## Generate study population - winter2021 

  generate_study_population-winter2021:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_winter2021
      --output-format csv.gz
    outputs:
      highly_sensitive:
        cohort: output/input_winter2021.csv.gz

  ## Describe - input_winter2021.csv.gz 

  describe-input_winter2021:
    run: stata-mp:latest analysis/describe.do input_winter2021 csv
    outputs:
      highly_sensitive:
        cohort: output/describe-input_winter2021.log

  ## Data cleaning - winter2021 

  data_cleaning-winter2021:
    run: stata-mp:latest analysis/data_cleaning.do winter2021 td(1dec2021) td(28feb2022)
    needs: generate_study_population_winter2021
    outputs:
      moderately_sensitive:
        consort: output/consort_winter2021.csv
        rounded_consort: output/rounded_consort_winter2021.csv
      highly_sensitive:
        cohort: output/clean_winter2021.dta.gz

  ## Describe - clean_winter2021.dta.gz 

  describe-input_winter2021:
    run: stata-mp:latest analysis/describe.do clean_winter2021 dta
    outputs:
      highly_sensitive:
        cohort: output/describe-clean_winter2021.log

  ## Table 1 - winter2021 

  table1-winter2021:
    run: stata-mp:latest analysis/table1.do winter2021
    needs: data_cleaning_winter2021
    outputs:
      moderately_sensitive:
        table1: output/table1_winter2021.csv
        rounded_table1: output/rounded_table1_winter2021.csv

  ## Table 2 - winter2021 

  table2-winter2021:
    run: stata-mp:latest analysis/table2.do winter2021
    needs: data_cleaning_winter2021
    outputs:
      moderately_sensitive:
        table1: output/table2_winter2021.csv
        rounded_table1: output/rounded_table2_winter2021.csv

